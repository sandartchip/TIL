

## 1. 기존에 대한 개선사항
- Fast R-CNN은 기본적으로 GPU를 이용하지만, **영역 추정은 CPU에서 수행 함.**
- Selective Search는 CPU에서 이미지 당 2초가 걸릴 정도로 매우 느림.
- GPU로 영역 추정을 하도록 영역 추정 네트워크를 재설계하는 경우, 어떻게 피처 맵 계산결과를 공유할지는 다시 고민해 봐야 함.
- Faster R-CNN은 영역 추정과 이미지 분류를 하나의 통합 네트워크에서 수행 함. 

## 2. RPN (Region Proposal Network) 

- 합성곱 피처들을 공유하기 때문에 Region Proposal에 비용이 거의 들지 않음.
- RPN은 객체의 bounding box와 클래스 점수를 동시에 예측하는 합성곱 네트워크임.
- 품질 좋은 영역 추정 경계 박스를 생성하도록 end-to-end training 가능.
- RPN은 다양한 스케일과 가로 세로 비율을 갖는 영역 추정 경계박스를 효과적으로 예측하도록 설계 됨.
- 이미지 피라미드나 필터 피라미드를 사용한 기존 모델과 다르게, Faster R-CNN은 앵커 박스(anchor boxes)를 사용함.

- RPN은 크기에 상관없이 이미지 전체를 입력받음. 그 다음 region proposal bounding box를 바노한함.
- 각 경계 박스는 객체가 있는지 여부를 점수로 나타냄. 이러한 RPN을 합성곱 네트워크로 처리하도록 만듬.
- 앞서 말했듯 RPN과 Fast R-CNN 객체 탐지기는 Feature Map을 공유함.
- 영역 추정 경계 박스를 만들기 위해, 슬라이딩 윈도우 방식을 적용함.

- 각 슬라이딩 윈도우는 작은 차원의 피처로 매핑됨. (ZF에서는 256차원, VGG에서는 512차원).
- 슬라이딩 윈도우로 구한 피처는 두 가지 전결합 계층에 입력됨. 첫 번째는 분류 계층이고, 두 번째는 Bounding Box Regression 계층임. 


### 2.1 Anchors
- 앵커 박스는 여러 스케일과 가로세로 비율을 가짐.
- 앵커 박스를 사용한다면, 다양한 스케일과 가로세로 비율을 갖는 이미지나 필터를 사용하지 않아도 되기 때문에, 다시 말해 단일 스케일 이미지만 사용해도 되기 떄문에 속도가 빠름.
- 각 슬라이딩 윈도우의 중심 위치마다 여러 경계 박스 영역을 예측함.
- 각 슬라이딩 윈도우 위치마다 최대로 예측할 수 있는 경계 박스영역 갯수는 k개임.
- 그렇기 때문에 회귀 계층(reg layer)는 좌표값을 4k개 가짐. bounding box하나에는 총 4가지 좌표값이 있으므로 k개 경계 박스에는 4k가 있는 것임.
- 분류 계층은 2k개의 점수 값을 가짐. 경계 박스 하나에는 객체일 확률과 아닐 확률 두 가지 확률값이 있기 때문임.
- RPN에서 사용하는 이런 형태의 경계 박스를 앵커 박스(anchor box)라고 함. 여기서는 k=9개 임.
- 즉, 앵커 박스가 9개. 3가지 스케일과 3가지 가로세로 비율(1:1, 2:1, 1:2)을 결합해 앵커 박스를 만듬.

- 피처 맵 크기가 WxH개라면 앵커 박스 갯수는 (WxHxk)가 됨. 보통 WxH는 2400이고 k=9로 설정했으니 전체 앵커 박스 갯수는 2400*9 = 21600개가 됨.

### Translation-Invariant Anchors
- Faster R-CNN의 중요한 특성은 위치 불변성(Translation-Invariance)임.
- 위치 불변성이란 이미지 안에서 객체 위치가 변하더라도 같은 객체로 인식하는 특성임.
- Faster R-CNN의 RPN은 슬라이딩 윈도우 방식으로 이미지의 전체 영역을 훑기 때문에 위치가 변해도 같은 객체로 잘 인식함.

### Multi-Scale Anchors as Regression References
- 멀티 스케일 예측에는 세 가지 방법이 있음.
a) 이미지 파리마드 방식. OverFeat, SPP-net에서 이미지 피라미드 방식 사용. 입력 이미지를 다양한 크기(멀티 스케일)로 조정해서 각 스케일마다 피처 맵을 구함.
효율적이지만 시간이 오래 걸림. 
b) 필터(슬라이딩 윈도우)를 다양한 크기(머맅 스케일)로 사용하는 방법이 있음. 피처 맵은 하나지만 다양한 필터를 사용해 풀링하는 방법. 필터 피라미드 방식으로 부름.
c) 기존에 사용하던 이미지 피라미드, 필터 피라미드보다 더 빠르고 효율적인 앵커 피라미드 방식을 소개 함.
다양한 크기의 앵커 박스를 통해 객체 분류, bounding box 회귀를 수행. anchor pyramid 방식을 적용하면 추가 연산없이 feature를 공유할 수 있어 효율적임.

### Loss Function
- RPN을 트레이닝하기 위해, 각 앵커박스마다 이진분류를 수행 함.
- 앵커 박스에 객체가 있는지 없는지 여부를 이진분류함.
- 분류를 하려면 앵커 박스에 positive label이 있어야 함.
- 두 가지를 positive label로 감안
i) ground-truth box와 IoU가 가장 큰 앵커 또는 ii) ground-truth box와 IoU가 0.7이 넘는 앵커



### 참고자료
<br>
https://bkshin.tistory.com/entry/%EB%85%BC%EB%AC%B8-%EB%A6%AC%EB%B7%B0-Faster-R-CNN-%ED%86%BA%EC%95%84%EB%B3%B4%EA%B8%B0#:~:text=Faster%20R%2DCNN%EC%9D%80%20%EA%B8%B0%EC%A1%B4,%EC%9D%84%20%EB%81%8C%EC%96%B4%EC%98%AC%EB%A6%B0%20%EB%AA%A8%EB%8D%B8%EC%9E%85%EB%8B%88%EB%8B%A4.
